<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG to SVG Vectorizer Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .preview {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview img {
            max-width: 100%;
            max-height: 300px;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        input, button {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #45a049;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        .error {
            color: #ff0000;
        }
        .success {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>PNG to SVG Vectorizer Test</h1>
    
    <div class="container">
        <!-- Direct Upload Card -->
        <div class="card">
            <h2>Direct Upload Method</h2>
            <p>This method posts directly to the server and displays the result in a new tab.</p>
            
            <form id="directForm" method="POST" enctype="multipart/form-data" target="_blank">
                <div>
                    <label for="directImage">Select PNG Image:</label>
                    <input type="file" id="directImage" name="image" accept="image/png,image/jpeg" required>
                </div>
                <div class="preview" id="directPreview">
                    <p>Image preview will appear here</p>
                </div>
                <div>
                    <button type="submit" id="directSubmit">Vectorize Image</button>
                </div>
            </form>
            
            <div class="status" id="directStatus"></div>
        </div>
        
        <!-- AJAX Upload Card -->
        <div class="card">
            <h2>AJAX Upload Method</h2>
            <p>This method uses JavaScript to send the image and display the result inline.</p>
            
            <form id="ajaxForm">
                <div>
                    <label for="ajaxImage">Select PNG Image:</label>
                    <input type="file" id="ajaxImage" name="image" accept="image/png,image/jpeg" required>
                </div>
                <div class="preview" id="ajaxPreview">
                    <p>Image preview will appear here</p>
                </div>
                <div>
                    <button type="submit" id="ajaxSubmit">Vectorize Image</button>
                </div>
            </form>
            
            <div class="status" id="ajaxStatus"></div>
            
            <div class="preview" id="resultPreview">
                <p>SVG result will appear here</p>
            </div>
        </div>
        
        <!-- Request Log -->
        <div class="card">
            <h2>Debug Log</h2>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // Global variables
        const BACKEND_URL = 'https://puzzle-craft-forge-production.up.railway.app';
        const VECTORIZE_ENDPOINT = '/api/vectorize/direct';
        const VECTORIZE_API_ENDPOINT = '/api/vectorize';
        
        // Logging function
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 8);
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // Direct form handling
        const directForm = document.getElementById('directForm');
        const directInput = document.getElementById('directImage');
        const directPreview = document.getElementById('directPreview');
        const directStatus = document.getElementById('directStatus');
        
        directForm.action = BACKEND_URL + VECTORIZE_ENDPOINT;
        
        directInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                log(`Direct: File selected - ${file.name} (${file.type}, ${(file.size/1024).toFixed(2)} KB)`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    directPreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
                
                directStatus.textContent = 'Ready to vectorize';
                directStatus.className = 'status';
            }
        });
        
        directForm.addEventListener('submit', function(e) {
            log(`Direct: Form submitted to ${this.action}`);
            directStatus.textContent = 'Processing...';
            directStatus.className = 'status';
            
            // Allow the form to submit normally - result will open in new tab
        });
        
        // AJAX form handling
        const ajaxForm = document.getElementById('ajaxForm');
        const ajaxInput = document.getElementById('ajaxImage');
        const ajaxPreview = document.getElementById('ajaxPreview');
        const ajaxStatus = document.getElementById('ajaxStatus');
        const resultPreview = document.getElementById('resultPreview');
        
        ajaxInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                log(`AJAX: File selected - ${file.name} (${file.type}, ${(file.size/1024).toFixed(2)} KB)`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    ajaxPreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
                
                ajaxStatus.textContent = 'Ready to vectorize';
                ajaxStatus.className = 'status';
            }
        });
        
        ajaxForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!ajaxInput.files || !ajaxInput.files[0]) {
                ajaxStatus.textContent = 'Please select an image first';
                ajaxStatus.className = 'status error';
                return;
            }
            
            const file = ajaxInput.files[0];
            const formData = new FormData();
            formData.append('image', file);
            formData.append('options', JSON.stringify({
                threshold: 128,
                steps: 1,
                background: '#ffffff',
                fillStrategy: 'dominant'
            }));
            
            ajaxStatus.textContent = 'Processing...';
            ajaxStatus.className = 'status';
            resultPreview.innerHTML = '<p>Processing...</p>';
            
            log(`AJAX: Sending request to ${BACKEND_URL}${VECTORIZE_API_ENDPOINT}`);
            
            fetch(BACKEND_URL + VECTORIZE_API_ENDPOINT, {
                method: 'POST',
                body: formData,
                mode: 'cors',
                // Don't set Content-Type header, let the browser set it with the boundary
            })
            .then(response => {
                log(`AJAX: Response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                log(`AJAX: Response received: ${JSON.stringify(data).substring(0, 100)}...`);
                
                if (data.status === 'success' && data.svg) {
                    ajaxStatus.textContent = 'Vectorization successful!';
                    ajaxStatus.className = 'status success';
                    
                    // Display the SVG
                    resultPreview.innerHTML = data.svg;
                    
                    // Add download button
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'Download SVG';
                    downloadBtn.onclick = function() {
                        const blob = new Blob([data.svg], {type: 'image/svg+xml'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `vectorized-${Date.now()}.svg`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    };
                    resultPreview.appendChild(downloadBtn);
                } else {
                    ajaxStatus.textContent = data.message || 'Vectorization failed';
                    ajaxStatus.className = 'status error';
                    resultPreview.innerHTML = '<p>Error: ' + (data.message || 'Unknown error') + '</p>';
                }
            })
            .catch(error => {
                log(`AJAX: Error - ${error.message}`);
                ajaxStatus.textContent = 'Error: ' + error.message;
                ajaxStatus.className = 'status error';
                resultPreview.innerHTML = '<p>Error: ' + error.message + '</p>';
            });
        });
        
        // Initial log
        log('Page loaded. Ready for testing.');
    </script>
</body>
</html> 